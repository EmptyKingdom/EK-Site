/**
 * Option Tree UI
 * 
 * Dependencies: jQuery, jQuery UI, ColorPicker
 *
 * @author Derek Herman (derek@valendesigns.com)
 */(function(e){OT_UI={processing:!1,init:function(){this.init_hide_body();this.init_sortable();this.init_add();this.init_edit();this.init_remove();this.init_edit_title();this.init_edit_id();this.init_activate_layout();this.init_upload();this.init_upload_remove();this.init_tabs();this.init_radio_image_select();this.init_select_wrapper();this.fix_upload_parent();this.fix_colorpicker();this.fix_textarea();this.replicate_ajax();this.reset_settings()},init_hide_body:function(t,n){var r=".option-tree-setting-body";n=="parent"?e(r).not(t.parent().parent().children(r)).hide():n=="child"?t.closest("ul").find(r).not(t.parent().parent().children(r)).hide():n=="child-add"?t.children().find(r).hide():n=="toggle"?t.parent().parent().children(r).toggle():e(r).hide()},init_remove_active:function(t,n){var r=".option-tree-setting-edit";n=="parent"?e(r).not(t).removeClass("active"):n=="child"?t.closest("ul").find(r).not(t).removeClass("active"):n=="child-add"?t.children().find(r).removeClass("active"):e(r).removeClass("active")},init_sortable:function(){e(".option-tree-sortable").each(function(){if(e(this).children("li").length){var t=e(this);t.show();t.sortable({items:"li:not(.ui-state-disabled)",handle:"div.open",placeholder:"ui-state-highlight",start:function(e,t){t.placeholder.height(t.item.height()-2)},stop:function(e,n){setTimeout(function(){OT_UI.update_ids(t)},200)}})}})},init_add:function(){e(".option-tree-section-add").live("click",function(e){e.preventDefault();OT_UI.add(this,"section")});e(".option-tree-setting-add").live("click",function(e){e.preventDefault();OT_UI.add(this,"setting")});e(".option-tree-help-add").live("click",function(e){e.preventDefault();OT_UI.add(this,"contextual_help")});e(".option-tree-choice-add").live("click",function(e){e.preventDefault();OT_UI.add(this,"choice")});e(".option-tree-list-item-add").live("click",function(e){e.preventDefault();OT_UI.add(this,"list_item")});e(".option-tree-list-item-setting-add").live("click",function(t){t.preventDefault();if(e(this).parents("ul").parents("ul").hasClass("ui-sortable")){alert(option_tree.setting_limit);return!1}OT_UI.add(this,"list_item_setting")})},init_edit:function(){e(".option-tree-setting-edit").live("click",function(t){t.preventDefault();if(e(this).parents().hasClass("option-tree-setting-body")){OT_UI.init_remove_active(e(this),"child");OT_UI.init_hide_body(e(this),"child")}else{OT_UI.init_remove_active(e(this),"parent");OT_UI.init_hide_body(e(this),"parent")}e(this).toggleClass("active");OT_UI.init_hide_body(e(this),"toggle")})},init_remove:function(){e(".option-tree-setting-remove").live("click",function(t){t.preventDefault();if(e(this).parents("li").hasClass("ui-state-disabled")){alert(option_tree.remove_no);return!1}var n=confirm(option_tree.remove_agree);if(n){var r=e(this).parents("ul");OT_UI.remove(this);setTimeout(function(){OT_UI.update_ids(r)},200)}return!1})},init_edit_title:function(){e(".option-tree-setting-title").live("keyup",function(){OT_UI.edit_title(this)})},init_edit_id:function(){e(".section-id").live("keyup",function(){OT_UI.update_id(this)})},init_activate_layout:function(){e(".option-tree-layout-activate").live("click",function(){var t=e(this).parents(".option-tree-setting").find(".open").text();e(".option-tree-layout-activate").removeClass("active");e(this).toggleClass("active");e(".active-layout-input").attr({value:t})});e("#option-tree-options-layouts-form select").live("change",function(){var t=confirm(option_tree.activate_layout_agree);if(t)e("#option-tree-options-layouts-form").submit();else{var n=e("#the_current_layout").attr("value");e('#option-tree-options-layouts-form select option[value="'+n+'"]').attr({selected:"selected"});e("#option-tree-options-layouts-form select").prev("span").replaceWith("<span>"+n+"</span>")}})},add:function(t,n){var r=this,i="",s="",o="",u=0,a="",f="";if(n=="contextual_help"){i=e(t).parent().find("ul:last");s="list-contextual-help"}else if(n=="choice"){i=e(t).parent().children("ul");s="list-choice"}else if(n=="list_item"){i=e(t).parent().children("ul");s="list-sub-setting"}else if(n=="list_item_setting"){i=e(t).parent().children("ul");s="list-sub-setting"}else{i=e(t).parent().find("ul:first");s=n=="section"?"list-section":"list-setting"}o=i.data("name");u=i.data("id");a=i.data("getOption");f=e("#"+o+"_settings_array").val();if(this.processing===!1){this.processing=!0;var l=parseInt(i.children("li").length);n=="list_item"&&i.find("li input.option-tree-setting-title").each(function(){var t=e(this).attr("name").replace(/[^0-9]/g,"");t=parseInt(t);t++;t>l&&(l=t)});e.ajax({url:option_tree.ajax,type:"post",data:{action:"add_"+n,count:l,name:o,post_id:u,get_option:a,settings:f,type:n},complete:function(e){if(n=="choice"||n=="list_item_setting"){OT_UI.init_remove_active(i,"child-add");OT_UI.init_hide_body(i,"child-add")}else{OT_UI.init_remove_active();OT_UI.init_hide_body()}i.append('<li class="ui-state-default '+s+'">'+e.responseText+"</li>");i.children().last().find(".option-tree-setting-edit").toggleClass("active");i.children().last().find(".option-tree-setting-body").toggle();i.children().last().find(".option-tree-setting-title").focus();n!="contextual_help"&&OT_UI.update_ids(i);setTimeout(function(){OT_UI.init_sortable();OT_UI.init_select_wrapper()},500);r.processing=!1}})}},remove:function(t){e(t).parent().parent().parent("li").remove()},edit_title:function(t){this.timer&&clearTimeout(t.timer);this.timer=setTimeout(function(){e(t).parent().parent().parent().parent().parent().children(".open").text(t.value)},100);return!0},update_id:function(t){this.timer&&clearTimeout(t.timer);this.timer=setTimeout(function(){OT_UI.update_ids(e(t).parents("ul"))},100);return!0},update_ids:function(t){var n,r,i=t.children("li");i.each(function(t){if(e(this).hasClass("list-section")){r=e(this).find(".section-id").val().trim().toLowerCase().replace(/[^a-z0-9]/gi,"_");r||(r=e(this).find(".section-title").val().trim().toLowerCase().replace(/[^a-z0-9]/gi,"_"));r||(r=n)}e(this).hasClass("list-setting")&&e(this).find(".hidden-section").attr({value:r});n=r})},init_upload:function(){e(".ot_upload_media").live("click",function(){var t=e(this).parent(".option-tree-ui-upload-parent").find("input").attr("id"),n=e(this).attr("rel"),r=window.send_to_editor,i="",s=window.setInterval(function(){e("#TB_iframeContent").attr("src").indexOf("&field_id=")!==-1&&e("#TB_iframeContent").contents().find("#tab-type_url").hide();e("#TB_iframeContent").contents().find(".savesend .button").val(option_tree.upload_text)},50);tb_show("","media-upload.php?post_id="+n+"&field_id="+t+"&type=image&TB_iframe=1");window.send_to_editor=function(n){var o=e(n).find("img").attr("src");typeof o=="undefined"&&(o=e(n).attr("href"));if(OT_UI.url_exists(o)){var u=/\.(?:jpe?g|png|gif|ico)$/i;o.match(u)&&(i+='<div class="option-tree-ui-image-wrap"><img src="'+o+'" alt="" /></div>');i+='<a href="javascript:(void);" class="option-tree-ui-remove-media option-tree-ui-button" title="'+option_tree.remove_media_text+'"><span class="icon trash-can">'+option_tree.remove_media_text+"</span></a>"}e("#"+t).val(o);e("#"+t+"_media").remove();e("#"+t).parent().parent("div").append('<div class="option-tree-ui-media-wrap" id="'+t+'_media" />');e("#"+t+"_media").append(i).slideDown();OT_UI.fix_upload_parent();tb_remove();window.clearInterval(s);window.send_to_editor=r};return!1})},init_upload_remove:function(){e(".option-tree-ui-remove-media").live("click",function(e){e.preventDefault();var t=confirm(option_tree.remove_agree);if(t){OT_UI.remove_image(this);return!1}return!1})},init_upload_fix:function(t){var n=e(t).attr("id"),r=e(t).val(),i=e(t).parent().next("option-tree-ui-media-wrap").find("img"),s=i.attr("src"),o="";r!=s&&i.attr("src",r);if(r===""||typeof s!="undefined"&&s!=0||!OT_UI.url_exists(r))(r==""||!OT_UI.url_exists(r))&&e(t).parent().next(".option-tree-ui-media-wrap").remove();else{var u=/\.(?:jpe?g|png|gif|ico)$/i;r.match(u)&&(o+='<div class="option-tree-ui-image-wrap"><img src="'+r+'" alt="" /></div>');o+='<a href="javascript:(void);" class="option-tree-ui-remove-media option-tree-ui-button" title="'+option_tree.remove_media_text+'"><span class="icon trash-can">'+option_tree.remove_media_text+"</span></a>";e("#"+n).val(r);e("#"+n+"_media").remove();e("#"+n).parent().parent("div").append('<div class="option-tree-ui-media-wrap" id="'+n+'_media" />');e("#"+n+"_media").append(o).slideDown()}},init_tabs:function(){e(".wrap.settings-wrap .ui-tabs").tabs({fx:{opacity:"toggle",duration:"fast"}}).bind("tabsselect",function(t,n){e("input[name='_wp_http_referer']").val(n.tab)})},init_radio_image_select:function(){e(".option-tree-ui-radio-image").live("click",function(){e(this).closest(".type-radio-image").find(".option-tree-ui-radio-image").removeClass("option-tree-ui-radio-image-selected");e(this).toggleClass("option-tree-ui-radio-image-selected");e(this).parent().find(".option-tree-ui-radio").attr("checked",!0)})},init_select_wrapper:function(){e(".option-tree-ui-select").each(function(){if(!e(this).parent().hasClass("select-wrapper")){e(this).wrap('<div class="select-wrapper" />');e(this).parent(".select-wrapper").prepend("<span>"+e(this).find("option:selected").text()+"</span>")}});e(".option-tree-ui-select").live("change",function(){e(this).prev("span").replaceWith("<span>"+e(this).find("option:selected").text()+"</span>")});e(".option-tree-ui-select").bind(e.browser.msie?"click":"change",function(t){e(this).prev("span").replaceWith("<span>"+e(this).find("option:selected").text()+"</span>")})},bind_colorpicker:function(t){e("#"+t).ColorPicker({onSubmit:function(n,r,i){e("#"+t).val("#"+r)},onBeforeShow:function(){e(this).ColorPickerSetColor(this.value);return!1},onChange:function(n,r,i){var s=e.inArray(r,["FFFFFF","FFF","ffffff","fff"])!=-1?"ccc":r;e("#cp_"+t).css({backgroundColor:"#"+r,borderColor:"#"+s});e("#cp_"+t).prev("input").attr("value","#"+r)}}).bind("keyup",function(){e(this).ColorPickerSetColor(this.value)})},fix_upload_parent:function(){e(".option-tree-ui-upload-input").live("focus blur",function(){e(this).parent(".option-tree-ui-upload-parent").toggleClass("focus");OT_UI.init_upload_fix(this)})},remove_image:function(t){e(t).parent().parent().find(".option-tree-ui-upload-input").attr("value","");e(t).parent(".option-tree-ui-media-wrap").remove()},fix_colorpicker:function(){e(".cp_input").live("blur",function(){e(".cp_input").each(function(t,n){var r=e(n).val(),i=/^[A-Fa-f0-9]{6}$/;i.test(r)&&r!=""?e(n).attr("value","#"+r):r==""&&e(this).next(".cp_box").css({background:"#f1f1f1","border-color":"#ccc"})})})},fix_textarea:function(){e(".wp-editor-area").focus(function(){e(this).parent("div").css({borderColor:"#bbb"})}).blur(function(){e(this).parent("div").css({borderColor:"#ccc"})})},replicate_ajax:function(){if(location.href.indexOf("#")!=-1){var t=e("input[name='_wp_http_referer']").val(),n=location.href.substr(location.href.indexOf("#"));e("input[name='_wp_http_referer']").val(t+n);this.scroll_to_top()}setTimeout(function(){e(".wrap.settings-wrap .fade").fadeOut("fast")},3e3)},reset_settings:function(){e(".reset-settings").live("click",function(e){var t=confirm(option_tree.reset_agree);return t?!0:!1})},url_exists:function(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);t.send();return t.status!=404},scroll_to_top:function(){setTimeout(function(){e(this).scrollTop(0)},50)}};e(document).ready(function(){OT_UI.init()})})(jQuery);